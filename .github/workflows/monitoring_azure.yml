name: Docker Image CI

on:
  push:
    branches: [ "dev" ]

env:
  resource_group_name: monitoring_app
  aks_cluster_name: monitoring_app_aks


jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: monitoringappeus.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build Docker image
      run: |
        docker build -t monitoringappeus.azurecr.io/mon_app:latest .
        
    - name: Push Docker image to ACR
      run: |
        docker push monitoringappeus.azurecr.io/mon_app:latest

    - name: Install Azure cli
      run: |
        sudo apt-get install ca-certificates curl apt-transport-https lsb-release gnupg
        curl -sL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/microsoft.gpg > /dev/null
        AZ_REPO=$(lsb_release -cs)
        echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main" | sudo tee /etc/apt/sources.list.d/azure-cli.list
        sudo apt-get update          
        sudo apt-get install azure-cli

      # Logs in with your Azure credentials
    - name: Azure login
      uses: azure/login@v1.4.6
      with:
        client-id: ${{ secrets.CLIENT_ID }}
        tenant-id: ${{ secrets.TENANT_ID }}
        subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

    - name: Configure Kubernetes context
      run: az aks get-credentials --resource-group $resource_group_name --name $aks_cluster_name

    - name: Update Kubernetes Manifest with Docker Image
      run: |
        sed -i "s|DOCKER_IMAGE|<dockerhub_username>/<image_name>:latest|g" manifests/deployment.yaml

    - name: Deploy to AKS
      run: kubectl apply -f manifests/deployment.yaml

